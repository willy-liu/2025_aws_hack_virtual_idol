<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Virtual Idol Live</title>

  <link rel="stylesheet" href="/static/style.css" />
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
</head>
<body>
  <div class="container">
    <div class="video-box">
      <video id="video" muted></video>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

    <div class="chat-box">
      <div id="messages" class="chat-messages"></div>

      <div class="chat-input">
        <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." />
        <button id="sendBtn">é€å‡º</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- WebSocket ---------- */
    let ws;
    const pendingVideos = [];      // FIFO ä½‡åˆ—

    function connectWebSocket() {
      ws = new WebSocket(`ws://${location.host}/ws`);

      ws.onopen = () => console.log("âœ… WebSocket é€£ç·šæˆåŠŸ");

      ws.onmessage = ev => {
        const data = JSON.parse(ev.data);

        if (data.type === "switch") {      // {url, ts}
          pendingVideos.push(data);
          pendingVideos.sort((a, b) => a.ts - b.ts);
          console.log("ğŸ“© æ”¶åˆ°å½±ç‰‡ï¼Œä½‡åˆ—", pendingVideos.length);
          return;
        }
        if (data.type === "ack")  console.log("âœ” ack", data.id);
        if (data.type === "chat") appendChat(data.text, "server");
      };

      ws.onclose = () => {
        console.warn("WebSocket é—œé–‰ï¼Œé‡é€£ä¸­â€¦");
        setTimeout(connectWebSocket, 3000);
      };
      ws.onerror = err => console.error("WebSocket éŒ¯èª¤ï¼š", err);
    }
    connectWebSocket();

    /* ---------- DOM ---------- */
    const inputEl = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const chatBox = document.getElementById("messages");

    function sendMessage() {
      const t = inputEl.value.trim();
      if (!t) return;
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(t); appendChat(t, "me"); inputEl.value = "";
      } else console.error("WS é—œé–‰ï¼Œç„¡æ³•ç™¼é€");
    }
    sendBtn.onclick = sendMessage;
    inputEl.addEventListener("keydown", e => e.key === "Enter" && sendMessage());

    function appendChat(text, who) {
      const div = document.createElement("div");
      div.textContent = `${who}> ${text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    /* ---------- æ’­æ”¾é‚è¼¯ ---------- */
    const videoEl = document.getElementById("video");
    const defaultList = [
      "generate/default_1.mp4",
      "generate/default_2.mp4",
      "generate/default_3.mp4",
      "generate/default_4.mp4",
      "generate/default_5.mp4",
    ];
    let defaultIdx = 0;

    videoEl.addEventListener("ended", tryPlayNext);

    playVideo(defaultList[defaultIdx]);   // INIT

    async function tryPlayNext() {
      // 1) å…ˆçœ‹ä½‡åˆ—é ‚ç«¯
      if (pendingVideos.length > 0) {
        const next = pendingVideos[0];    // ä¸å…ˆ shiftï¼

        const ok = await exists(next.url);
        if (ok) {
          console.log("â³ æª”æ¡ˆæº–å‚™å¥½äº†");
          pendingVideos.shift();          // ç¢ºå®šå­˜åœ¨æ‰çœŸæ­£æ‹¿å‡º
          playVideo(next.url);
        } else {
          console.log("â³ æª”æ¡ˆé‚„æ²’å¥½ï¼Œå†ç­‰ç­‰â€¦");
          setTimeout(tryPlayNext, 2000);  // 2 ç§’å¾Œé‡è©¦
        }
        return;
      }

      // 2) ä½‡åˆ—ç©º â†’ æ’­ default split
      defaultIdx = (defaultIdx + 1) % defaultList.length;
      playVideo(defaultList[defaultIdx]);
    }

    function playVideo(path) {
      videoEl.src = `${path}?t=${Date.now()}`;   // é˜²å¿«å–
      videoEl.load();
      videoEl.play().catch(err => console.error("æ’­æ”¾å¤±æ•—ï¼š", err));
    }

    async function exists(url) {
      try {
        const r = await fetch(url, { method:"HEAD" });
        return r.ok;
      } catch { return false; }
    }
  </script>
</body>
</html>
